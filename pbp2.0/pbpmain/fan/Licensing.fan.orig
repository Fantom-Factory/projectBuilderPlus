using fwt
using web
using pbpcore
using kayako
using pbplogging

** Check license against licensing server.
internal class Licensing{

  private Str key1 := "I"+(8+1).toStr+"HBRREUyeZq8Bt21eM7AqsqGX"+"3hP8pwwXaVH8PwKnlminipOE1pedLfRRn2r6VPTQ0UHvlJn7NABaFmhEHaIeG"+"U10OHBYataWBy"
  private Str key2 := "ShpFVOp1V"+"jDkiXw1zHRYK8F"+(2+2).toStr+"GIVgjujJRwJ5nuDO9"+"tuzkpsgh2P3r8GldnKManvcBQEah2QpMJ9mtTdJSHuueBSIFjoDa92D0ZXX"
  private Str key3 := "P7fFWuNgXaRchieJ"+"qrw3Vk7t3HWm05JaiA"+(3+2).toStr+"boBluqCEja8RN1lKIJdR"+"vAC4g4VMwLyKHVHSTQ6Zg3h9O44bOhDGRTIDok"+"lapcTPh"
  private Str key4 := "aOCd2jX9H"+"conzYLJTJieWOh8H3Dgd4a0dSLAZpvwELnGOZK03tN"+(11-2).toStr+"1FomJpILAyyUtXKzpv7WRHPM"+"UDQJaxfvp7doE7Ueu4kJIg"+"vA"

  private File? liscenseFile
  private File? requestFile
  private Str? uuid
  Str? name
  Str? companyName
  Str? host
  Str? recLimit
  Str? timeCreated
  Str? key
  Str? skysparkIds
  
  Str:Str skysparkHostIds := [:]

  private MacAddressFinder addressFinder := MacAddressFinder()

  Bool checkLicense()
  {
    lookupLicenseFile
    lookupRequestFile
    if(liscenseFile == null && requestFile.exists)
    {
      fetched := fetchLicense
      if(!fetched)
      {
        Dialog.openWarn(null,"The license has not been approved yet.\nPlease try again later.")
        return false
      }
    }

    liscenseFile = File(Env.cur.homeDir.toStr.toUri+`resources/auth/`).listFiles.find |File f -> Bool|{return f.ext == "lic"}
    if(liscenseFile == null)
    {
      Logger.log.info("No License file found")

      showLicenseForm
      return false
    }
    readLicense
    valid := false
    // check against all valid interfaces in case new ones showed up
    addressFinder.findAll.eachWhile |MacAddress address -> Bool?|
    {
      Str toHash := name + companyName + host + recLimit + uuid + timeCreated + getMacAddressHash(address) + (skysparkIds ?: "")
      Str[] keysToCheck := [rotate(key1, -11), rotate(key2, -22), rotate(key3, -44), rotate(key4, -66)]
      Str[] linesToCheck := [,]
      keysToCheck.shuffle.each |keyz|{
        linesToCheck.push(toHash.toBuf.hmac("MD5", keyz.toBuf).toHex.toStr)
      }
      valid = linesToCheck.contains(key)
      if(valid)
        return true
      return null
    }
    if(! valid)
    {
      Logger.log.info("Invalid license file : $liscenseFile.osPath")
      Dialog.openWarn(null,"Invalid License $liscenseFile.name")
    }
    else
    {
      Logger.log.info("Accepted license : $liscenseFile.osPath")
      return true
    }
    return false
  }
    
  ** call to bass server and check whether the license is active or not
  Bool fetchLicense()
  {
    company := requestFile.readAllStr
    data := ["company" : company, "key" : getMacAddressHash(addressFinder.find)]
    try
    {
      Logger.log.info("Fetching license for $company")
      url := "http://"+Env.cur.index("bass.licensing.server.url").first+":"+Env.cur.index("bass.licensing.server.port").first+"/fetch"
      webCon := WebClient(url.toUri)
      webCon.socketOptions.receiveTimeout = 30sec
      webCon.postForm(data)
      resCode := webCon.resCode
      licenseData := webCon.resIn.readAllStr
      if(resCode!=200)
      {
        Logger.log.info("License retrieval failed: $resCode")
        return false
      }

      File? liscenseFile := File(Env.cur.homeDir.toStr.toUri+`resources/auth/${company.trim}.lic`)
      liscenseFile.out.print(licenseData).close

      return true
    }
    catch(IOErr e)
    {
      Logger.log.info("Failed fetching the license ! $e")
    }
    catch(Err e)
    {
      Logger.log.info("Failed fetching the license ! $e")
    }
    return false
  }

  Void showLicenseForm()
  {
    name := Text{prefCols = 20}
    company := Text{prefCols = 20}
    email := Text{prefCols = 20}
    po := Text{prefCols = 20}
    hostname := Text{prefCols = 20; text = Env.cur.host}
    Str button := "cancel"
    Window? w
    w = Window(null)
    {
      title = "You need to request a License"
      alwaysOnTop = true
      InsetPane
      {
        GridPane
        {
          numCols = 2
          Label{text = "Name"},
          name,
          Label{text = "Company"},
          company,
          Label{text = "Email"},
          email,
          Label{text = "PO"},
          po,
          Label{text = "Hostname"},
          hostname,
          Button{text="Request License"; onAction.add {button = "license" ; w.close}},
          Button{text="Request SAS License"; onAction.add {button = "sasLicense" ; w.close}},
          Button{text="Cancel"; onAction.add {w.close}},
        },
      },
    }
    w.open

    if(button != "cancel")
    {
      compName := ""
      company.text.trim.each {compName += (it.isAlphaNum ? it.toChar : "_")}
      compName.replace("," , "_")
      key := getMacAddressHash(addressFinder.find)
      data := [
        "Name" : name.text,
        "Company" : compName,
        "Email" : email.text,
        "PO" : po.text,
        "Hostname" : hostname.text,
        "Key" : key,
        "Mactype" : addressFinder.find.type,
        "LicType" : button=="license" ? "standalone" : "sas"
      ]

      Dialog.openInfo(null, "Press Ok to send the license data to the server.")

      // send data
      try
      {
        url := "http://"+Env.cur.index("bass.licensing.server.url").first+":"+Env.cur.index("bass.licensing.server.port").first+"/request"
        webCon := WebClient(url.toUri)
        webCon.postForm(data)
        webCon.close

        File? requestFile := File(Env.cur.homeDir.toStr.toUri+`resources/auth/request.txt`)
        requestFile.out.print(compName).close

        // creating kayako ticket
        KayakoApi.createLicenseTicket(data["Company"], data["Name"], data["Email"], data.toStr)

        Dialog.openInfo(null, "License data was sent to the server.")
      }
      catch(Err e)
      {
        Logger.log.info("Failed to send the license data to the server ! $e")
        Dialog.openWarn(null, "Failed to send the license data to the server ! $e")
      }

    }
  }

  ** Get the (valid) mac addresses - Obfuscated a bit into an MD5 hash
  internal Str getMacAddressHash(MacAddress address)
  {
    if(address.type == "M")
    {
      return address.address
    }
    buf:= Buf().print("projectBuilder") // salt
    address.bytes.each {buf.print(it)}
    hash := buf.toDigest("MD5").toHex
    return hash
  }

  internal Str rotate(Str str, Int offset)
  {
    Buf s := Buf().writeUtf(str)
    (0 ..< str.size).each
    {
      idx := it + offset
      if(idx >= str.size)
        idx = idx - str.size
      else if(idx < 0)
        idx = str.size + idx
      a := str[it]
      s[idx] = str[it]
    }
    return s.flip[0 ..< str.size].readAllStr
  }

  Void lookupLicenseFile()
  {
    liscenseFile = File(Env.cur.homeDir.toStr.toUri+`resources/auth/`).listFiles.find |File f -> Bool|{return f.ext == "lic"}
  }

  Void lookupRequestFile()
  {
    requestFile = File(Env.cur.homeDir.toStr.toUri+`resources/auth/request.txt`)
  }

  Void readLicense()
  {
    Str[] values := liscenseFile.readAllLines
    uuid = values[0].split(',')[1]
    name = values[1].split(',')[1]
    companyName = values[2].split(',')[1]
    host = values[3].split(',')[1]
    recLimit = values[4].split(',')[1]
    timeCreated = values[5].split(',')[1]
    key = values[6].split(',')[1]
<<<<<<< local
    if(values.size>6)
        skysparkId = values[7].split(',')[1]
=======
    if(values.size > 7 && values[7].startsWith("SkysparkIds"))
        skysparkIds = values[7].split(',')[1..-1].join(",")
        Logger.log.info("spids: $skysparkIds")
    if(skysparkIds != null)
    {
      skysparkHostIds.clear
      skysparkIds.split(',').each |item|
      {
        Logger.log.info(item)
        if(! item.trim.isEmpty && item.contains(":"))
        {
          parts := item.split(':')
          skysparkHostIds[parts[0]] = parts[1]
        }  
      }
    }    
>>>>>>> other
  }

  ** Check license limit against val records
  ** return false if too many records and warn the user + kayako ticket
  Bool checkLicenseLimit(Int val)
  {
    if(recLimit.toInt < val)
    {
        Dialog.openInfo(null, "Sorry the project has $val records, but your license only allows for $recLimit ")
        contents:="License upgrade request for:\n\nName:${name}\nCompany:${companyName}\nHost:${host}\nRecords:val\n\nkey:${key}"
        KayakoApi.makeTicket(null, ["departmentid":"7","subject":"License upgrade", "company":companyName,
                                "fullname":name, "contents":contents])
        Dialog.openInfo(null, "Thank you, we will contact you shortly about your icense upgrade.")
        return false
    }
    // ok license
    return true
  }
}

